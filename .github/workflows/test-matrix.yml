name: CI Test Matrix

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test-kernels:
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        kernel:
          - name: "OEM 6.14"
            package: "linux-headers-6.14.0-1000-oem"
            version: "6.14"
          - name: "OEM 6.17"
            package: "linux-headers-6.17.0-1000-oem"
            version: "6.17"
          - name: "HWE 6.17"
            package: "linux-headers-6.17.0-20-generic"
            version: "6.17"

    name: Test on ${{ matrix.kernel.name }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y debhelper dkms devscripts

      - name: Build Debian package
        run: |
          dpkg-buildpackage -us -uc -b

      - name: Install kernel headers
        run: |
          # Add proposed repository for newer kernels
          sudo add-apt-repository -y proposed || true
          sudo apt-get update

          # Try to install the specific kernel headers
          sudo apt-get install -y ${{ matrix.kernel.package }} || {
            echo "Warning: Could not install ${{ matrix.kernel.package }}"
            echo "Available kernel headers:"
            apt-cache search linux-headers | grep -E "(oem|generic)" | grep ${{ matrix.kernel.version }} || true
            echo "Installing any available ${{ matrix.kernel.version }} headers..."
            sudo apt-get install -y $(apt-cache search linux-headers | grep -E "oem|generic" | grep ${{ matrix.kernel.version }} | head -1 | awk '{print $1}') || true
          }

      - name: Install DKMS package
        run: |
          sudo dpkg -i ../*.deb || {
            echo "Package installation failed, checking dependencies..."
            sudo apt-get install -f -y
            sudo dpkg -i ../*.deb
          }

      - name: Verify DKMS build
        run: |
          echo "=== DKMS Status ==="
          dkms status amdxdna

          # Extract version from changelog
          VERSION=$(dpkg-parsechangelog -S Version | cut -d- -f1)

          # Verify module was built
          if dkms status amdxdna/$VERSION | grep -q "installed"; then
            echo "✓ Module successfully built and installed"
          else
            echo "✗ Module build failed"
            exit 1
          fi

      - name: Verify firmware installation
        run: |
          echo "=== Firmware Files ==="
          ls -lR /lib/firmware/updates/amdnpu/

          echo ""
          echo "=== Verify Symlinks ==="
          for device in 1502_00 17f0_10 17f0_11; do
            if [ -L "/lib/firmware/updates/amdnpu/$device/npu.sbin" ]; then
              echo "✓ $device/npu.sbin symlink exists"
            else
              echo "✗ $device/npu.sbin symlink missing"
              exit 1
            fi

            if [ -L "/lib/firmware/updates/amdnpu/$device/npu_7.sbin" ]; then
              echo "✓ $device/npu_7.sbin symlink exists"
            else
              echo "✗ $device/npu_7.sbin symlink missing"
              exit 1
            fi
          done

      - name: Check module info
        run: |
          echo "=== Module Information ==="
          # Find the built module
          VERSION=$(dpkg-parsechangelog -S Version | cut -d- -f1)
          KERNEL=$(ls /lib/modules/ | grep ${{ matrix.kernel.version }} | head -1)

          if [ -n "$KERNEL" ]; then
            MODULE_PATH="/lib/modules/$KERNEL/updates/dkms/amdxdna.ko"
            if [ -f "$MODULE_PATH" ]; then
              modinfo "$MODULE_PATH" || true
            else
              echo "Module not found at $MODULE_PATH"
            fi
          else
            echo "No matching kernel found in /lib/modules/"
          fi
