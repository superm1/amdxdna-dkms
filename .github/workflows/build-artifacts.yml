name: Build Artifacts

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-deb:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y debhelper dkms devscripts

      - name: Build Debian package
        run: |
          dpkg-buildpackage -us -uc -b

      - name: List package contents
        run: |
          echo "=== Built packages ==="
          ls -lh ../*.deb
          echo ""
          echo "=== Package contents ==="
          dpkg-deb -c ../*.deb

      - name: Upload Debian package
        uses: actions/upload-artifact@v4
        with:
          name: amdxdna-dkms-deb
          path: ../*.deb
          retention-days: 30

      - name: Upload build logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: ../*.build
          retention-days: 7
          if-no-files-found: ignore
